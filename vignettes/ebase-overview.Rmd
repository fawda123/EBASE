---
title: "EBASE overview"
output: rmarkdown::html_vignette
bibliography: refs.bib
vignette: >
  %\VignetteIndexEntry{EBASE overview}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  message = F, 
  warning = F, 
  fig.align = 'center'
)
```

## Installation 

This vignette provides an overview of the theory and use of the the Estuarine BAyesian Single-station Estimation (EBASE) R package for ecosystem metabolism.  Use the following to install the package from R-Universe.  The [JAGS](https://mcmc-jags.sourceforge.io/) software must also be installed to use this package.  Follow the instructions in the link to download and install the JAGS version appropriate for your operating system.   


``` r
# Enable the r-universe repo
options(repos = c(
    fawda123 = 'https://fawda123.r-universe.dev',
    CRAN = 'https://cloud.r-project.org'))

# Install
install.packages('EBASE')
```

Load the package after installation to use the functions. 

```{r}
library(EBASE)
```

## Usage

An example file called `exdat()` is included with the package that demonstrates the required time series format to use the functions.  It includes nearly a year of continuously monitored water quality and meteorological data at the Apalachicola National Estuarine Research Reserve.  The required data include a date and time vector (`DateTimeStamp`), dissolved oxygen (mg/L, `DO_obs`) , water temperature (C, `Temp`), salinity (psu, `Sal`), PAR (W/m2/s, `PAR`), and wind speed (m/s, `WSpd`).  The time step should be consistent throughout the dataset and is indicated as an argument to the `ebase()` function (see below).  The `exdat()` dataset can be viewed at any time after the package is loaded and is used in the examples in the help files:

```{r}
head(exdat)
```

The core function to estimate metabolism is `ebase()`.  The metabolic estimates are based on a mass balance equation in @Grace15 with the gas exchange estimate from @Wanninkhof14.  It is similar to that provided by the BASEmetab R package at https://github.com/dgiling/BASEmetab, with modifications to estimate different parameters optimized by the JAGS model: 

$$
\frac{\delta{C_d}}{\delta{t}} = [\,aPAR]\, - [\,r]\, - \frac{1}{H}\left[-bU_{10}^2\left(\frac{s_c}{600} \right)^{-0.5} \left(C_{Sat} - C_d \right )\right]
$$

The metabolic estimates are defined by the change in dissolved oxygen over the time step $\frac{\delta{C_d}}{\delta{t}}$, where gross production is provided by $aPAR$, respiration is provided by $r$, and gas exchange is provided by the remainder.  Required inputs for the equation are dissolved oxygen concentration as $C_d$, solar radiation as $PAR$, water column depth as $H$ (meters), and wind speed as $U$.  Other inputs for the schmidt number $s_c$ and dissolved oxygen at saturation $C_{Sat}$ are calculated from the observed data by the package.  The remaining three parameters $a$, $r$, and $b$ are estimated by likelihood given the observed data with the JAGS model using prior distributions shown in the model file. At each time step, the change in oxygen concentration between time steps is calculated from the equation using model inputs and parameter guesses, and then a finite difference approximation is used to estimate modeled oxygen concentration.  The estimated concentration is also returned, which can be compared to observed as one measure of model performance.

The following shows how to use the `ebase()` function with a subset of four days from the `exdat()` example dataset.  Running the model on the entire year will take a few minutes, so a subset is used: 

```{r}
library(dplyr)
library(lubridate)

# subset four days in June
dat <- exdat %>%
  filter(month(exdat$DateTimeStamp) == 6 & day(exdat$DateTimeStamp) %in% 1:4)

head(dat)
```

Then, the `ebase()` function is used to estimate the metabolic rates with the appropriate function arguments.  The timestep `interval` is 900 seconds (15 minutes), the water column depth `H` is 1.85 meters, a log file of the model iterations for each day is created by setting `progress = TRUE`, and only two Markov chains are used with `n.chains = 2`. In practice, a larger number for `n.chains` should be used to verify model convergence.  

```{r}
res <- ebase(dat, interval = 900, H = 1.85, progress = TRUE, n.chains = 2)
head(res)
```

The results are returned as a data frame with instantaneous metabolic estimates for volumetric gross production (O2 mmol/m3/d, `Pg_vol` or $aPAR$ from above), respiration (O2 mmol/m3/d, `Rt_vol` or $r$ from above), and gas exchange (O2 mmol/m3/d, `D` or the remainder of the equation from above).  Additional parameters estimated by the model that are returned include `a` and `b` as shown in the above equation.  The `a` parameter is a constant that represents the primary production per quantum of light with units of  (mmol/m3/d)(W/m2) and is used to estimate gross production [@Grace15].  The `b` parameter is a constant used to estimate gas exchange in (cm/hr)/(m2/s2) (provided as 0.251 in eqn. 4 in @Wanninkhof14).

A plot of the results can be made with `ebase_plot()`.

```{r, fig.height = 3, fig.width = 9}
ebase_plot(res)
```

The daily averages can also be plotted by using `instantaneous = FALSE`.

```{r, fig.height = 3, fig.width = 9}
ebase_plot(res, instantaneous = FALSE)
```

Execution time of the model can also be reduced by using multiple processors.  This is done using [doParrallel](https://cran.r-project.org/web/packages/doParallel/index.html) package and registering a parallel backend as below. 

```{r}
# setup parallel backend
library(doParallel)
cl <- makeCluster(2)
registerDoParallel(cl)

res <- ebase(dat, interval = 900, H = 1.85, progress = TRUE, n.chains = 2)

stopCluster(cl)
```

# References