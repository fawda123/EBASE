---
title: "EBASE overview"
output: rmarkdown::html_vignette
bibliography: refs.bib
vignette: >
  %\VignetteIndexEntry{EBASE overview}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  message = F, 
  warning = F, 
  fig.align = 'center'
)
```

## Installation 

This vignette provides an overview of the theory and use of the EBASE R package or Estuarine BAyesian Single-station Estimation method for ecosystem metabolism.  Use the following to install the package from R-Universe.  The [JAGS](https://mcmc-jags.sourceforge.io/) software must also be installed to use this package.  Follow the instructions in the link to download and install the version appropriate for your operating system.   


``` r
# Enable the r-universe repo
options(repos = c(
    fawda123 = 'https://fawda123.r-universe.dev',
    CRAN = 'https://cloud.r-project.org'))

# Install
install.packages('EBASE')
```

Load the package after installation to use the functions. 

```{r}
library(EBASE)
```

## Usage

An example file called `exdat()` is included with the package that demonstrates the required time series format to use the functions.  It includes nearly a year of continuously monitored water quality and meteorological data at the Appalachicola National Estuarine Research Reserve.  The required data include a date and time vector, dissolve oxygen (mg/L), water temperature (C), salinity (psu), PAR (W/m2/s), and wind speed (m/s).  The time step should be consistent throughout the dataset and is indicated as an argument to the `ebase()` function (see below).  The `exdat()` dataset can be viewed at any time after the package is loaded and is used in the examples in the help files:

```{r}
head(exdat)
```

The core function to estimate metabolism is `ebase()`.  The metabolic estimates are based on a mass balance equation in Grace et al. 2015 [@Grace15] with the gas exchange estimate from Wanninkhof 2014 [@Wanninkhof14].  It is similar to that provided by the BASEmetab R package at https://github.com/dgiling/BASEmetab, with modifications to estimate different parameters. The equation optimized in the JAGS model is: 

$$
\frac{\delta{C_d}}{\delta{t}} = [\,aPAR]\, - [\,r]\, - \frac{1}{H}\left[-bU_{10}^2\left(\frac{s_c}{600} \right)^{-0.5} \left(C_{Sat} - C_d \right )\right]
$$

Gross production is provided by *aPAR*, respiration is provided by *r*, and gas exchange is provided by the remainder.  The likelihood of the parameters *a*, *r*, and *b* given the observed data are estimated from the JAGS model using prior distributions shown in the model file. At each time step, the change in oxygen concentration between time steps is calculated from the equation using model inputs and parameter guesses, and then a finite difference approximation is used to estimate modeled oxygen concentration.  The estimated concentration is also returned for comparison to observed as one measure of model performance.

The following shows how to use the `ebase()` function with a subset of four days from the `exdat()` example dataset.  The subset is first created: 

```{r}
library(dplyr)
library(lubridate)

dat <- exdat %>%
  filter(month(exdat$DateTimeStamp) == 6 & day(exdat$DateTimeStamp) %in% 1:4)

head(dat)
```

Then, the `ebase()` function is used to estimate the metabolic rates with the appropriate function arguments.  The timestep `interval` is 900 seconds (15 minutes), the water column depth (`H`) is 1.85 meters, a log file of the model iterations for each day is created by setting `progress = TRUE`, and only two Markov chains are used (`n.chains` = 2). In practice, a larger number for `n.chains` should be used to verify model convergence.  

```{r}
res <- ebase(dat, interval = 900, H = 1.85, progress = TRUE, n.chains = 2)
head(res)
```

The results are returned as a data frame with instantaneous metabolic estimates for volumetric gross production (`Pg_vol`, O2 mmol/m3/d), respiration (`Rt_vol`,  O2 mmol/m3/d), and gas exchange (`D`, O2 mmol/m3/d).  Additional parameters estimated by the model that are returned include `a` and `b` as shown in the above equation.  The `a` parameter is a constant that represents the primary production per quantum of light with units of  (mmol/m3/d)(W/m2) and is used to estimate gross production [@Grace15].  The `b` parameter is a constant used to estimate gas exchange in hr/cm (provided as 0.251 in eqn. 4 in @Wanninkhof14).

A plot of the results can easily be made with \code{link[ggplot2]{ggplot}}, which is a dependeny of EBASE.  The instantaneous rates at the daily scale can be plotted after some wrangling with [dplyr](https://dplyr.tidyverse.org/) and [tidyr](https://tidyr.tidyverse.org/).

```{r, fig.height = 3, fig.width = 9}
library(ggplot2)
library(dplyr)
library(tidyr)

toplo <- res %>% 
  select(DateTimeStamp, Pg_vol, Rt_vol, D) %>% 
  pivot_longer(cols = -matches('DateTimeStamp'))

ggplot(toplo, aes(x = DateTimeStamp, y = value, color = name)) +
  geom_line() + 
  geom_point() + 
  theme_minimal() + 
  theme(
    legend.position = 'top'
  ) +
  labs(
    y = 'Instantaneous O2 mmol/m3/d', 
    color = NULL, 
    x = NULL
  )
```

The daily averages can also be plotted after summarizing the results.

```{r}
toplo <- res %>% 
  select(Date, Pg_vol, Rt_vol, D) %>% 
  pivot_longer(cols = -matches('Date')) %>% 
  group_by(Date, name) %>% 
  summarise(value = mean(value, na.rm = T), .groups = 'drop')

ggplot(toplo, aes(x = Date, y = value, color = name)) +
  geom_line() + 
  geom_point() + 
  theme_minimal() + 
  theme(
    legend.position = 'top'
  ) +
  labs(
    y = 'Daily avg. O2 mmol/m3/d', 
    color = NULL, 
    x = NULL
  )
```

Execution time of the model can also be reduced by registering a parallel backend. 

```{r}
# setup parallel backend
library(doParallel)
cl <- makeCluster(2)
registerDoParallel(cl)

res <- ebase(dat, interval = 900, H = 1.85, progress = TRUE, n.chains = 2)

stopCluster(cl)
```

